# Creates:
# - An IAM Policy Document with permissions to allow the IAM user to write to the S3 Bucket
# - An S3 Bucket to deploy the application into
# - An ENV file with the bucket name, region and the IAM User Credentials (used by Ember to deploy the app)

# TODO:
# - S3 Policy Bucket JSON file


### Implementation



# Create a policy for the bucket
data "aws_iam_policy_document" "app" {
  statement {
    effect    = "Allow"
    sid       = "Stmt1EmberCLIS3DeployPolicy"
    actions   = [
      "s3:GetObject",
      "s3:PutObject",
      "s3:PutObjectACL",
    ]
    resources = [
      "arn:aws:s3:::${var.bucket_name}/*",
    ]
    principals {
      type        = "AWS"
      identifiers = ["${var.iam_user_arn}"]
    }
  }

#   statement {
#     effect    = "Deny"
#     sid       = "IPDeny"
#     actions   = [
#       "s3:*",
#     ]
#     resources = [
#       "arn:aws:s3:::${var.bucket_name}/*",
#     ]
#     principals {
#       type        = "AWS"
#       identifiers = ["*"]
#     }
#     condition = {
#       test     = "IpAddress"
#       variable = "aws:SourceIp"
#       values   = [
#         "0.0.0.0/0"
#       ]
#     }
#     condition = {
#       test     = "NotIpAddress"
#       variable = "aws:SourceIp"
#       values   = [
#         "${var.cidr_blocks}"
#       ]
#     }
#   }
}


# Create a bucket for the Application
resource "aws_s3_bucket" "app" {
  bucket        = "${var.bucket_name}"
  policy        = "${data.aws_iam_policy_document.app.json}"
  region        = "${var.region}"
  acl           = "public-read"
  force_destroy = true
  website {
    index_document = "index.html"
    error_document = "index.html"
  }
}


# Create an ENV file used be ember-cli-deploy
data "template_file" "envs" {
  template = "${file("${path.module}/templates/bucket_env")}"
  depends_on = ["aws_s3_bucket.app"]
  vars {
    aws_bucket            = "${var.bucket_name}"
    aws_region            = "${var.region}"
    aws_access_key_id     = "${var.aws_access_key_id}"
    aws_secret_access_key = "${var.aws_secret_access_key}"
    api_url               = "${var.api_url}"
  }
}

resource "null_resource" "envs" {
  triggers {
    env_file = "${sha1(file("${var.credentials_file}"))}"
  }
  provisioner "local-exec" {
    command = "echo '${data.template_file.envs.rendered}' > ${var.credentials_file}"
  }
}
