### Implementation

resource "aws_db_subnet_group" "main" {
  name = "${var.identifier}-group"
  description = "RDS subnet group"
  subnet_ids = ["${var.vpc_subnet_ids}"]
}

resource "aws_security_group" "main" {
  name = "${var.identifier}-sg"
  description = "RDS Security Group"
  vpc_id      = "${var.vpc_id}"
}

resource "aws_security_group_rule" "allow_5432_inbound" {
  security_group_id = "${aws_security_group.main.id}"
  type              = "ingress"
  from_port         = 0
  to_port           = 5432
  protocol          = "TCP"
  cidr_blocks       = ["${var.cidr_blocks}"]
}

# resource "aws_security_group_rule" "idallow_5432_inbound" {
#   security_group_id = "${aws_security_group.main.id}"
#   type              = "egress"
# 
#   from_port         = 0
#   to_port           = 0
#   protocol          = "-1"
#   cidr_blocks       = ["0.0.0.0/0"]
# }


resource "aws_db_instance" "main" {
  allocated_storage         = "${var.allocated_storage}"
  availability_zone         = "${var.availability_zone}"
  backup_window             = "${var.backup_window}"
  backup_retention_period   = "${var.backup_retention_period}"
  count = 1
  db_subnet_group_name      = "${aws_db_subnet_group.main.name}"
  engine                    = "${var.engine}"
  engine_version            = "${var.engine_version}"
  final_snapshot_identifier = "${var.final_snapshot_identifier}"
  identifier                = "${var.identifier}"
  instance_class            = "${var.instance_class}"
  maintenance_window        = "${var.maintenance_window}"
  multi_az                  = "${var.multi_az}"
  name                      = "${var.name}"
  password                  = "${var.password}"
  parameter_group_name      = "${var.parameter_group_name}"
  port                      = "${var.port}"
  publicly_accessible       = "${var.publicly_accessible}"
  storage_encrypted         = "${var.storage_encrypted}"
  storage_type              = "${var.storage_type}"
  username                  = "${var.username}"
  # vpc_security_group_ids    = ["${var.vpc_security_group_ids}"]
  vpc_security_group_ids    = ["${aws_security_group.main.id}"]
  # kms_key_id
}


# Create an ENV file used be ember-cli-deploy
data "template_file" "envs" {
  template = "${file("${path.module}/templates/env")}"
  depends_on = ["aws_db_instance.main"]
  vars {
    db_instance_address = "${aws_db_instance.main.address}"
    ansible_vars_key    = "${var.ansible_vars_key}"
  }
}

resource "null_resource" "envs" {
  triggers {
    env_file = "${sha1(file("${var.ansible_vars_file}"))}"
  }
  provisioner "local-exec" {
    command = "echo '${data.template_file.envs.rendered}' > ${var.ansible_vars_file}"
  }
}
